name: Build ZMK Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with Docker
        run: |
          # Tạo thư mục output
          mkdir -p firmware

          echo "=== Kiểm tra cấu trúc thư mục ==="
          find config/ -type f | head -20

          # Chạy Docker build với phiên bản ZMK cố định
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            zmkfirmware/zmk-build-arm:3.2 \
            /bin/bash -c "
            set -e  # Dừng nếu có lỗi
            
            echo '=== Kiểm tra cấu trúc ==='
            find /workspace/config -type f 2>/dev/null | head -20
            
            # Tạo thư mục build
            mkdir -p /workspace/build
            
            echo '=== Clone ZMK với phiên bản ổn định ==='
            cd /tmp
            # Clone phiên bản ổn định hơn
            git clone --depth 1 --branch main https://github.com/zmkfirmware/zmk.git
            cd zmk
            
            echo '=== Setup west ==='
            west init -l app/
            west update
            west zephyr-export
            
            echo '=== Kiểm tra các shields có sẵn ==='
            find . -name '*.overlay' | grep -i filco || echo 'Không tìm thấy shield Filco'
            
            echo '=== Build firmware ==='
            # Build với cấu hình cụ thể
            west build -b nice_nano_v2 app -- \
              -DSHIELD=filco_majestouch_tkl \
              -DZMK_CONFIG=/workspace/config \
              -DWEST_PYTHON=/usr/bin/python3
            
            echo '=== Copy firmware ==='
            if [ -f build/zephyr/zmk.uf2 ]; then
              cp build/zephyr/zmk.uf2 /workspace/firmware/filco_tkl.uf2
              echo '✅ Đã copy firmware'
              ls -lh /workspace/firmware/
            else
              echo '❌ Không tìm thấy file firmware'
              ls -la build/zephyr/ 2>/dev/null || echo 'Thư mục build không tồn tại'
              exit 1
            fi
            "

      - name: Kiểm tra file firmware
        run: |
          echo "=== Danh sách file trong thư mục firmware ==="
          ls -la firmware/ 2>/dev/null || echo "Thư mục firmware trống"

          if [ -f firmware/filco_tkl.uf2 ]; then
            echo "✅ Tìm thấy file firmware"
            echo "Kích thước: $(wc -c < firmware/filco_tkl.uf2) bytes"
          else
            echo "❌ Không tìm thấy file firmware"
            exit 1
          fi

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: firmware/
