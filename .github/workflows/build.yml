name: Build ZMK Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with Docker
        run: |
          mkdir -p firmware

          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            --user $(id -u):$(id -g) \
            zmkfirmware/zmk-build-arm:3.5 \
            /bin/bash -ex -c "
            set -euo pipefail
            set -x

            echo '=== Clean /tmp/zmk if any ==='
            rm -rf /tmp/zmk

            echo '=== Clone ZMK repo (full depth for safety) ==='
            cd /tmp
            git clone https://github.com/zmkfirmware/zmk.git
            cd zmk
            echo 'ZMK commit:' $(git rev-parse --short HEAD) || true
            echo 'Listing root:'
            ls -la .

            echo '=== Try to get zephyr via git submodules (if any) ==='
            git submodule sync --recursive || true
            git submodule update --init --recursive || true
            echo 'After submodule update, check zephyr folder:'
            if [ -d zephyr ]; then
              echo '✅ zephyr present via submodule'
            else
              echo '❗ zephyr not present as submodule'
            fi
            ls -la | sed -n '1,200p'

            echo '=== Initialize west workspace pointing to local app ==='
            # tạo workspace app
            west init -l app/ || { echo 'west init failed'; exit 1; }
            # Nếu ZMK repo contains a manifest file for zephyr at zephyr/west.yml, try to use it:
            if [ -f zephyr/west.yml ]; then
              echo 'Found zephyr/west.yml in repo — re-init workspace using that manifest'
              # Re-init with absolute manifest path (file://) so west uses correct file
              rm -rf app/.west || true
              west init -l app/ -m file:///tmp/zmk/zephyr/west.yml || true
            fi

            echo '=== Run west update to fetch modules ==='
            cd $(west topdir) || true
            west update || true

            echo '=== If zephyr still missing, clone Zephyr directly as fallback ==='
            if [ ! -d zephyr ]; then
              echo 'Cloning zephyr directly from upstream as fallback...'
              git clone --depth 1 https://github.com/zephyrproject-rtos/zephyr.git zephyr || { echo 'Direct clone zephyr failed'; }
            fi

            echo '=== After all attempts, check zephyr presence ==='
            if [ -d zephyr ]; then
              echo '✅ zephyr is present at:' $(realpath zephyr)
              ls -la zephyr | sed -n '1,80p'
            else
              echo '❌ zephyr STILL MISSING — aborting'
              ls -la || true
              exit 2
            fi

            echo '=== Export Zephyr env (zephyr base) ==='
            west zephyr-export || true
            export ZEPHYR_BASE=${ZEPHYR_BASE:-$(west topdir)/zephyr}
            echo 'ZEPHYR_BASE='${ZEPHYR_BASE}

            echo '=== Show app dir & CMakeLists ==='
            ls -la app || true
            if [ -f app/CMakeLists.txt ]; then
              echo '✅ app/CMakeLists.txt exists'
            else
              echo '❌ app/CMakeLists.txt MISSING - build will fail'
            fi

            echo '=== Show mounted config in workspace ==='
            ls -la /workspace/config || true
            echo 'Show shield conf:'
            ls -la /workspace/config/boards/shields/filco_majestouch_tkl || true
            cat /workspace/config/boards/shields/filco_majestouch_tkl/filco_majestouch_tkl.conf || true

            echo '=== Start build (verbose). Full log to /workspace/build_full.log ==='
            # run build and pipe to log
            west build -p auto -b nice_nano_v2 app -- \
              -DSHIELD=filco_majestouch_tkl \
              -DZMK_CONFIG=/workspace/config \
              -DCONF_FILE=/workspace/config/boards/shields/filco_majestouch_tkl/filco_majestouch_tkl.conf \
              -v 2>&1 | tee /workspace/build_full.log || { echo '=== Build failed, tail of log ==='; tail -n 200 /workspace/build_full.log; exit 1; }

            echo '=== Copy firmware if built ==='
            if [ -f build/zephyr/zmk.uf2 ]; then
              cp build/zephyr/zmk.uf2 /workspace/firmware/filco_tkl.uf2
              echo '✅ Copied firmware'
              ls -lh /workspace/firmware/
            else
              echo '❌ No zmk.uf2 after build'
              ls -la build/zephyr || true
              exit 1
            fi
            "

      - name: Kiểm tra file firmware
        run: |
          echo "=== File trong thư mục firmware ==="
          ls -la firmware/ 2>/dev/null || echo "Thư mục firmware trống"

          if [ -f firmware/filco_tkl.uf2 ]; then
            echo "✅ Tìm thấy firmware"
            echo "Kích thước: $(wc -c < firmware/filco_tkl.uf2) bytes"
          else
            echo "❌ Không tìm thấy firmware"
            echo "Tìm kiếm file .uf2 trong toàn bộ workspace:"
            find . -name "*.uf2" 2>/dev/null || echo "Không tìm thấy file .uf2 nào"
            exit 1
          fi

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: firmware/
          retention-days: 7
