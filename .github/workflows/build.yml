name: Build ZMK Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: docker.io/zmkfirmware/zmk-build-arm:3.2
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: /github/workspace

      - name: Build
        run: |
          cd /github/workspace

          # Kiểm tra config
          echo "Checking config..."
          ls -la config/boards/shields/filco_majestouch_tkl/

          # Clone ZMK tươi mới
          cd /tmp
          git clone --depth 1 https://github.com/zmkfirmware/zmk.git
          cd zmk

          # Setup
          west init -l app/
          west update

          # Build
          echo "Building firmware..."
          west build -b nice_nano app -- \
            -DSHIELD=filco_majestouch_tkl \
            -DZMK_CONFIG=/github/workspace/config \
            --pristine

          # Copy output
          mkdir -p /github/workspace/firmware
          if [ -f "build/zephyr/zmk.uf2" ]; then
            cp build/zephyr/zmk.uf2 /github/workspace/firmware/
            echo "✅ Build successful!"
          else
            echo "❌ Build failed - no firmware file"
            ls -la build/zephyr/
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: /github/workspace/firmware
